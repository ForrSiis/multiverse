<%= form_for(@card) do |f| %>
  <% if @card.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@card.errors.count, "error") %> prohibited this card from being saved:</h2>

      <ul>
      <% @card.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

<table border="0">         <!-- grouping table -->
 <tr>
  <td style="vertical-align: top;">                      <!-- card -->
   <!-- div class="cardtabs" id="tabs">
    <a href="#cardimage">Image</a>
    <a href="#mockup">Mockup</a>
   </div>
   <div class="onetab" id="cardimage"><a name="cardimage"></a>
     <img src="">
   </div>
   <div class="onetab" id="prettycard"><a name="mockup"></a -->
   <div class="<%= @card.border_colour %>border">
   <div class="form card <%= @card.display_class %>" id="card">
    <div class="pinline pinline_box namebox">
     <div class="cardtitlebar">
      <!-- div class="cardname" --><table><tr><td>
       <div class="field">
        <%= f.label :name %><br />
        <%= f.text_field :name %>
       </div>
      <!-- /div --></td>
      <!-- div class="cardmanacost" --><td>
       <div class="field">
        <%= f.label :cost %><br />
        <%= f.text_field :cost,
          { :onchange => "update_frame()",
            :onkeyup => "update_frame()" } %>
       </div>
      <!-- /div --></td></tr></table>
     </div>
    </div>
    <div class="cardart_container">
     <div class="pinline pinline_sides">
      <div class="cardart">
       <%= f.label :art_url, "URL for art" %>
       <%= f.text_field :art_url, :class => "art_url_field" %>
      </div>
     </div>
    </div>
    <div class="pinline pinline_box">
     <div class="cardtypebar">
      <table><tr>
       <td>
        <div class="cardtype">
          <% if @card.supertype.blank? || Card.supertypes.include?(@card.supertype) %>
            <%= select_tag "card_supertype_select", options_for_select(Card.supertypes << "Custom", :selected => @card.supertype),
              { :onchange => "update_card_supertype(this.value)",
              :onkeyup => "update_card_supertype(this.value)", :include_blank => true } %>
            <% supertype_visibility = "none"; %>
          <% else %>
            <% supertype_visibility = "inline"; %>
          <% end %>
          <%= f.text_field :supertype, { :style => "display:#{supertype_visibility};" } %>
          <%= f.text_field :cardtype,
          { :onchange => "update_frame()",
            :onkeyup => "update_frame()" } %> &ndash;
          <%= f.text_field :subtype %>
        </div>
       </td>
       <td>
        <div class="cardrarity <%= @card.rarity %>" id="raritycell">
          <%= f.select :rarity, Card.rarities.map{|r| [r.capitalize, r]},
          { :selected => @card.rarity },
          { :onchange => "update_card_rarity(this.value)",
            :onkeyup => "update_card_rarity(this.value)",
            :onkeydown => "update_card_rarity(this.value)" } %>
        </div>
       </td>
      </tr></table>
     </div>
    </div>
    <div class="cardtext_container">
     <div class="pinline pinline_sidesbottom">
      <div class="cardtext">
       <%= f.text_area :rulestext,   :class => "rulestextfield"   %>
       <div class="flavourtext">
        <%= f.text_area :flavourtext, :class => "flavourtextfield" %>
       </div>
      </div>
     </div>
    </div>
    <div class="bottombox">
     Artist: <%= f.text_field :artist %>
     <div class="ptbox_container">
      <div class="pinline pinline_box pinline_ptbox">
       <div class="notptbox">
        <table style="margin: auto;"><tr>
         <td id="power_field"><%= f.text_field :power, :size => 5, :class => "powerfield" %></td>
         <td id="pt_slash">/</td>
         <td id="toughness_field"><%= f.text_field :toughness, :size => 5, :class => "toughnessfield" %></td>
        </td></tr></table>
      </div>
     </div>
    </div>
   </div>
  </div>
  </div>
  </td>                    <!-- end of card -->

  <td style="vertical-align: top;">           <!-- controls, comments etc -->
   <table>
    <% code = @card.code || params[:code]%>
    <% if !code.blank? && @cardset.skeleton %>
     <tr>
      <td class="form_info_cell">Skeleton row</td>
      <td>
        <% skeleton_row = @cardset.get_skeleton_row(code) %>
        <% if !skeleton_row.blank? %>
         <div>
           <% mini_table = @cardset.get_skeleton_header_rows + skeleton_row %>
           <%= format_skeleton_table(format_all_markup(mini_table, @cardset)) %>
         </div>
        <% else %>
          <div>No skeleton entry for code "<%= code %>" found</div>
        <% end %>
      </td>
     </tr>
    <% end %>
    <tr>
     <td><%= f.label :image_url, "URL for whole card image" %>
     <td><%= f.text_field :image_url, :class => "image_url_field" %>
     </td>
    </tr>
    <% if @card.cardset.configuration.card_show_code %>
     <tr>
      <td><%= f.label :code %></td>
      <td><%= f.text_field :code %></td>
     </tr>
    <% else %>
     <%= f.hidden_field :code %>
    <% end %>
    <% if @card.cardset.configuration.card_show_active %>
     <tr>
      <td><%= f.label :active, "Active?" %></td>
      <td><%= f.check_box :active %></td>
     </tr>
    <% end %>
    <tr>
     <td><%= f.label :frame %></td>
     <% frames_keys = Card.display_frames %>
     <% frames_values = Card.frames %>
     <% frames = frames_keys.zip(frames_values) %>
     <td><%= f.select :frame, frames.unshift(["Auto", "Auto"]), {}, 
          { :onchange => "update_frame()" } %></td>
    </tr>
    <% if !@card.new_record? %>
     <tr>
      <td colspan="2">
       <br>
      <%= label_tag "edit_comment", "Enter a brief summary of the change you made:" %>
      <br><%= text_field_tag :edit_comment, params[:edit_comment], :class => "edit_comment_field" %>
      </td>
     </tr>
    <% end %>
    <tr>
     <td colspan="2">
      <%= f.hidden_field :cardset_id, :value => @card.cardset_id %>
      <%= f.submit %>
     </td>
    </tr>
   </table>
   <% if !@card.new_record? %>
     <br>
     <div>
       <ul class="cardtabs" id="tabs">
        <li><a href="#editing_help" id="editing_help_link">Help</a></li>
        <li><a href="#history">History</a></li>
       </ul>
     </div>
   <% end %>
   <div class="helptext onetab active-tab-body" id="editing_help">
      <p id="nonplaneswalker">
      Enter mana symbols like this: 
      <br><code>{2}{U}{U/R}, {T}</code> becomes <%= format_mana_symbols("{2}{U}{U/R}, {T}") %>
      </p>
      <p id="planeswalker">On planeswalkers, <code>[+1]</code> becomes <span class="loyalty_container"><span class="loyalty positive">+1</span></span>
      </p>
     <% if !@cardset.mechanics.empty? %>
       <p>
       Enter <%= link_to "mechanics", cardset_mechanics_path(@cardset) %> like this:
       <% @cardset.mechanics.all.each do |mech| %>
         <% src_no_reminder, src_with_reminder, target_no_reminder, target_with_reminder = mech.regexps 
         string_with_reminder = src_with_reminder.inspect.sub(Mechanic.one_param, "AA").sub(Mechanic.one_param, "BB").gsub(/\\|\//, "")
         string_no_reminder = src_no_reminder.inspect.sub(Mechanic.one_param, "AA").sub(Mechanic.one_param, "BB").gsub(/\\|\//, "") %>
         <br><code><%= string_with_reminder %></code> for <%= mech.name %>
         <% if !mech.reminder.blank? %>
           <br><code><%= string_no_reminder %></code> for <%= mech.name %> without reminder text
         <% end %>
       <% end %>
       </p>
     <% end %>
     <p>Abbreviations supported: 
<br><code>ETBs</code> becomes <code>enters the battlefield</code>
<br><code>UEOT</code> becomes <code>until end of turn</code>
<br><code>CMC</code> becomes <code>converted mana cost</code>
<br><code>~</code>, <code>~this~</code> and <code>CARDNAME</code>
become the card's name
<br>Surround with asterisks for <i>*italics*</i> and double-asterisks for <b>**bold**</b>
      </p>
    </div>
    <% if !@card.new_record? %>
    <div class="onetab" id="history">
      <%= render "history" %>
    </div>
    <% end %>
  </td>
 </tr>
</table>

   <script type="text/javascript">
     new Fabtabs("tabs", "editing_help_link");
   </script>
   
<% end %>
